# @name: wash_trade_detection
# @report_type: wash_trade
# @domain: trade_surveillance
# @capability: detect_wash_trades
# @tags: wash_trade, manipulation, self_dealing
# @description: Configuration for detecting wash trade patterns

wash_trade_detection:
  metadata:
    name: wash_trade_detection
    report_type: wash_trade
    domain: trade_surveillance
    version: "1.0"
    
  parameters:
    lookback_days: 30
    min_match_percentage: 0.95
    price_tolerance: 0.01
    time_window_seconds: 300
    
  thresholds:
    min_trade_count: 5
    min_volume: 1000
    max_time_gap_seconds: 60
    
  sql: |
    SELECT 
      t1.trade_id as buy_trade_id,
      t2.trade_id as sell_trade_id,
      t1.account_id,
      t1.symbol,
      t1.trade_time as buy_time,
      t2.trade_time as sell_time,
      t1.quantity,
      t1.price as buy_price,
      t2.price as sell_price,
      ABS(t1.price - t2.price) / t1.price as price_diff_pct,
      TIMESTAMPDIFF(SECOND, t1.trade_time, t2.trade_time) as time_gap_seconds
    FROM trades t1
    JOIN trades t2 ON t1.account_id = t2.account_id 
      AND t1.symbol = t2.symbol
      AND t1.trade_id != t2.trade_id
    WHERE t1.side = 'BUY' 
      AND t2.side = 'SELL'
      AND t1.trade_time >= :start_date
      AND t2.trade_time <= :end_date
      AND ABS(t1.quantity - t2.quantity) / t1.quantity <= :quantity_tolerance
      AND ABS(t1.price - t2.price) / t1.price <= :price_tolerance
      AND TIMESTAMPDIFF(SECOND, t1.trade_time, t2.trade_time) <= :time_window_seconds
    ORDER BY t1.trade_time DESC

  output:
    format: csv
    columns:
      - buy_trade_id
      - sell_trade_id
      - account_id
      - symbol
      - buy_time
      - sell_time
      - quantity
      - buy_price
      - sell_price
      - price_diff_pct
      - time_gap_seconds
